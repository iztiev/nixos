# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Overview

This is a NixOS flakes-based system configuration repository. The installation guides (`nixos_installation.md`, `nixos_cosmic_installation.md`) document the target setup: NixOS 25.11 with LUKS2 full disk encryption, Secure Boot via lanzaboote, NVIDIA RTX drivers on Wayland, KDE Plasma 6 / COSMIC desktop, and Home Manager for user configuration.

## Repository Structure

```
flake.nix                    # Entry point: all inputs, nixosConfigurations
nixos/
  configuration.nix          # Core system config (boot, network, users, packages)
  hardware-configuration.nix # Auto-generated by nixos-generate-config — do NOT edit
home-manager/
  home.nix                   # Home Manager user config
modules/
  nixos/default.nix          # Reusable NixOS modules
  home-manager/default.nix   # Reusable Home Manager modules
overlays/default.nix         # Custom nixpkgs overlays
pkgs/default.nix             # Custom package derivations
```

## Common Commands

```bash
# Rebuild and switch to new configuration
sudo nixos-rebuild switch --flake .#<hostname>

# Build only (don't activate)
nixos-rebuild build --flake .#<hostname>

# Test configuration (activated, but rolls back on reboot)
sudo nixos-rebuild test --flake .#<hostname>

# Update all flake inputs (nixpkgs, home-manager, etc.)
nix flake update

# Update a single flake input
nix flake lock --update-input nixpkgs

# Check flake syntax without building
nix flake check

# Search for a package
nix search nixpkgs <package-name>

# Evaluate a specific config option
nix eval .#nixosConfigurations.<hostname>.config.<option.path>

# Roll back to previous generation
sudo nixos-rebuild switch --flake .#<hostname> --rollback

# List system generations
sudo nix-env --list-generations --profile /nix/var/nix/profiles/system

# Secure Boot: verify signed boot files
sudo sbctl verify
sudo sbctl status
```

## Architecture

### flake.nix pattern

Always use `@inputs` to capture all inputs and `specialArgs` to make them available in modules:

```nix
outputs = { self, nixpkgs, home-manager, ... }@inputs: {
  nixosConfigurations.hostname = nixpkgs.lib.nixosSystem {
    specialArgs = { inherit inputs; };   # Makes inputs.* available in all modules
    modules = [ ./nixos/configuration.nix ];
  };
};
```

All dependency inputs must follow nixpkgs to avoid duplicate evaluations:
```nix
home-manager.inputs.nixpkgs.follows = "nixpkgs";
lanzaboote.inputs.nixpkgs.follows = "nixpkgs";
```

### Home Manager integration

Home Manager is integrated as a NixOS module (`home-manager.nixosModules.home-manager`), not standalone. The configuration block in `configuration.nix` or a host-specific file controls how it's wired:

```nix
home-manager.useGlobalPkgs = true;      # HM uses system pkgs
home-manager.useUserPackages = true;
home-manager.users.<username> = import ../home-manager/home.nix;
home-manager.extraSpecialArgs = { inherit inputs; };  # Makes inputs.* available in home.nix
```

### Overlay scope — critical rule

When `useGlobalPkgs = true`, overlays defined inside `home.nix` (`nixpkgs.overlays = [...]`) are **silently ignored** because Home Manager isn't creating its own pkgs instance. Overlays must be defined at the NixOS level:

```nix
# ❌ WRONG — in home-manager/home.nix with useGlobalPkgs = true
nixpkgs.overlays = [ inputs.some-overlay.overlays.default ];  # has no effect

# ✅ CORRECT — in the home-manager config block within configuration.nix
nixpkgs.overlays = [ inputs.some-overlay.overlays.default ];
```

### System vs user packages

- **System** (`environment.systemPackages`): services, hardware drivers, system utilities available to all users
- **Home Manager** (`home.packages`): user applications, desktop apps, user-specific dev tools, shell configs

Do not duplicate packages in both locations.

### hardware-configuration.nix

This file is auto-generated by `nixos-generate-config` and will be overwritten if re-run. Put all custom kernel parameters, module settings, and hardware tweaks in `configuration.nix` instead.

## Available Skills

Use `/nixos-best-practices` when working on overlay issues, flake structure, host organization, or package placement. It provides detailed rules and examples in `.agents/skills/nixos-best-practices/rules/`.
